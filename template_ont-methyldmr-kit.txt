#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 24 # number of cores
#SBATCH --mem 48G # memory pool for all cores
#SBATCH -t 0-06:00 # time (D-HH:MM)
#SBATCH -o ont_methyldmr_kit_{0}.%N.%j.log
#SBATCH -e ont_methyldmr_kit_{0}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={1}

ml apptainer/1.4.5 nextflow/25.10.2

export NXF_DEFAULT_CPUS=1
export NXF_DISABLE_UPDATE_CHECK=true
export NXF_OFFLINE=true
export NXF_SINGULARITY_CACHEDIR="/lustre09/project/6019267/shared/tools/methylation/ont-methylDMR-kit/ont-methylDMR-kit_cache"
export NXF_TEMP=/lustre10/scratch/$USER/{2}/results/ont-methylDMR-kit/{0}/tmp

tool_dir="/lustre09/project/6019267/shared/tools/methylation/ont-methylDMR-kit"
output_dir="/lustre10/scratch/$USER/{2}/results/ont-methylDMR-kit/{0}"
pileups_dir={3}
STEPS_DONE="{4}/scripts/steps_done.txt"

gunzip -k $pileups_dir/{0}.wf_mods.1.bedmethyl.gz
gunzip -k $pileups_dir/{0}.wf_mods.2.bedmethyl.gz

nextflow run $tool_dir -profile offline \
        -c $tool_dir/nextflow.config \
        -w $output_dir/tmp \
        --input_file1 $pileups_dir/{0}.wf_mods.1.bedmethyl \
        --input_file2 $pileups_dir/{0}.wf_mods.2.bedmethyl \
        --phased_mC \
        --output_dir $output_dir/


if [ $? -eq 0 ]; then
    echo "ont_methyldmr_kit_{0}" >> "$STEPS_DONE"
fi