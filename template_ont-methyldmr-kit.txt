#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 6 # number of cores
#SBATCH --mem 12G # memory pool for all cores
#SBATCH -t 0-02:00 # time (D-HH:MM)
#SBATCH -o ont_methyldmr_kit.%N.%j.log
#SBATCH -e ont_methyldmr_kit.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={0}

set -euo pipefail

ml apptainer/1.4.5 nextflow/25.10.2

export NXF_DEFAULT_CPUS=1
export NXF_OVERRIDE_AVAILABLE_CPUS=6
export _JAVA_OPTIONS="-XX:ActiveProcessorCount=6"
export NXF_DEFAULT_MEMORY=2GB
export NXF_DISABLE_UPDATE_CHECK=true
export NXF_OFFLINE=true
export NXF_SINGULARITY_CACHEDIR="/lustre09/project/6019267/shared/tools/methylation/ont-methylDMR-kit/ont-methylDMR-kit_cache"

tool_dir="/lustre09/project/6019267/shared/tools/methylation/ont-methylDMR-kit"
STEPS_DONE="{1}/scripts/steps_done.txt"

for sample in {2}
do  
    echo -e "\n===== Running $sample =====\n"

    export NXF_TEMP={3}/ont-methylDMR-kit/$sample/tmp
    output_dir="{3}/ont-methylDMR-kit/$sample"
    
    gunzip -k {3}/epi2me/$sample/$sample.wf_mods.1.bedmethyl.gz
    gunzip -k {3}/epi2me/$sample/$sample.wf_mods.2.bedmethyl.gz

    nextflow run $tool_dir -profile offline \
            -c $tool_dir/nextflow.config \
            -w $output_dir/tmp \
            --input_file1 {3}/epi2me/$sample/$sample.wf_mods.1.bedmethyl \
            --input_file2 {3}/epi2me/$sample/$sample.wf_mods.2.bedmethyl \
            --phased_mC \
            --output_dir $output_dir/ \
            --threads 1
done

if [ $? -eq 0 ]; then
    echo "ont_methyldmr_kit" >> "$STEPS_DONE"
fi
