#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH --cpus-per-task={0}
#SBATCH --mem {1}G # memory pool for all cores
#SBATCH -t {2} # time (DD-HH:MM)
#SBATCH -o {3}_{4}.%N.%j.log
#SBATCH -e {3}_{4}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={5}
#
module load nextflow
module load apptainer
#
export NXF_DEFAULT_CPUS=1
export NXF_OVERRIDE_AVAILABLE_CPUS={0}
export NXF_DEFAULT_MEMORY=4GB
export NXF_DISABLE_UPDATE_CHECK=true
export NXF_OFFLINE=true
export NXF_SINGULARITY_CACHEDIR="/lustre09/project/6019267/shared/tools/main_pipelines/long-read/epi2me_cache/"
export _JAVA_OPTIONS="-XX:ActiveProcessorCount={0}"
#
WORKDIR="/lustre10/scratch/$USER/epi2me_work/{4}"
BAM="{6}/alignments/{4}_sorted.bam"
OUT="{6}/results/{4}"
APPTAINER_CONFIG="/lustre09/project/6019267/shared/tools/main_pipelines/long-read/apptainer_nextflow_no_slurm.config"
STEPS_DONE="{6}/scripts/steps_done.txt"
#
mkdir -p $OUT
#
nextflow run epi2me-labs/wf-human-variation \
    {7} \
    --bam_min_coverage 4 \
    --override_basecaller_cfg {9} \
    -w $WORKDIR \
    --bam $BAM \
    --ref {8} \
    --sample_name {4} \
    --out_dir $OUT \
    --threads 1 \
    --ubam_map_threads 1 \
    --ubam_sort_threads 1 \
    --ubam_bam2fq_threads 1 \
    --modkit_threads 1 \
    -c $APPTAINER_CONFIG \
    -profile slurm_local
#
if [ $? -eq 0 ]; then
    echo "epi2me_{4}" >> "$STEPS_DONE"
fi
#
echo "Deleting $WORKDIR ..."
rm -r $WORKDIR
echo "Deletion complete - epi2me pipeline for {4} done!"
