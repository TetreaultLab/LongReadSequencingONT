#!/bin/bash                                                                                 
#SBATCH -N 1 #Number of nodes                                                               
#SBATCH -n 1 # number of cores                                                              
#SBATCH --mem 3G # memory pool for all cores                                                
#SBATCH -t 0-01:00 # time (D-HH:MM)                                                         
#SBATCH -o trgt_{0}.%N.%j.log                                                                   
#SBATCH -e trgt_{0}.%N.%j.log                                                                                                                                              
#SBATCH --mail-type=FAIL                                                                    
#SBATCH --account=rrg-tetreaum                                                              
#SBATCH --mail-user={1}

ml apptainer samtools bcftools                                                                                                                                                                             # Tool                                                                                      
IMAGE="apptainer run /lustre09/project/6019267/shared/tools/repeat_expansions/TRGT/trgt.sif"                                                                                            

# Project Directory
WORKDIR="/lustre10/scratch/$USER/{2}/results/TRGT/{0}"

# Steps done
STEPS_DONE="{3}/scripts/steps_done.txt"

# Reference Genome Path
GENOME={4}

# Repeat Definition File Path
REPEATS="/lustre09/project/6019267/shared/tools/repeat_expansions/reference_regions/trgt_STRchive_pathogenic.hg38.bed"

# Optional for visualization and python script
# Gene of Interest
GOI={5}
MOTIF={6}

### Repeat quantification with TRGT/TRVZ

mkdir -p $WORKDIR

# Main TRGT Command
$IMAGE trgt genotype --genome $GENOME \
            --repeats $REPEATS \
           	--reads /lustre10/scratch/$USER/{2}/alignments/{0}_sorted.bam  \
         	--output-prefix $WORKDIR/{0}

# Sort and index VCF
bcftools sort -Ob -o $WORKDIR/{0}.sorted.vcf.gz $WORKDIR/{0}.vcf.gz
bcftools index $WORKDIR/{0}.sorted.vcf.gz

# Sort and index BAM
samtools sort -o $WORKDIR/{0}.spanning.sorted.bam $WORKDIR/{0}.spanning.bam
samtools index $WORKDIR/{0}.spanning.sorted.bam

if [ -z "$GOI" ]; then
    if [ $? -eq 0 ]; then
        echo "trgt_{0}" >> "$STEPS_DONE"
    fi
else
    # Visualizer
    $IMAGE trgt plot --genome $GENOME \
                --repeats $REPEATS \
                --vcf $WORKDIR/{0}.sorted.vcf.gz \
                --spanning-reads $WORKDIR/{0}.spanning.sorted.bam \
                --repeat-id $GOI \
                --image $WORKDIR/{0}_$GOI.svg

    rm $WORKDIR/{0}.spanning.bam
    rm $WORKDIR/{0}.vcf.gz

    # Optional
    python3 /lustre09/project/6019267/shared/tools/main_pipelines/long-read/LongReadSequencingONT/tools_specific_scripts/TRGT/countTRGT.py $WORKDIR/ $GENE $MOTIF $WORKDIR/summaryTRGT_$GOI_$MOTIF.txt

    if [ $? -eq 0 ]; then
        echo "trgt_{0}" >> "$STEPS_DONE"
    fi
fi