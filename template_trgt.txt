#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 1 # number of cores
#SBATCH --mem 2G # memory pool for all cores
#SBATCH -t 0-01:00 # time (D-HH:MM)
#SBATCH -o trgt.%N.%j.log
#SBATCH -e trgt.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={0}

ml apptainer samtools bcftools
IMAGE="apptainer run /lustre09/project/6019267/shared/tools/repeat_expansions/TRGT/trgt.sif"

STEPS_DONE="{1}/scripts/steps_done.txt"
GENOME={2}
REPEATS="/lustre09/project/6019267/shared/tools/repeat_expansions/reference_regions/trgt_STRchive_pathogenic.hg38.bed"

### Repeat quantification with TRGT/TRVZ
for sample in {3}
do
    echo -e "\n===== Running $sample =====\n"

    WORKDIR="/lustre10/scratch/$USER/{4}/results/TRGT/$sample"
    mkdir -p $WORKDIR

    # Main TRGT Command
    $IMAGE trgt genotype \
            --genome $GENOME \
            --repeats $REPEATS \
            --sample-name $sample \
            --reads /lustre10/scratch/$USER/{4}/alignments/$sample\_sorted.bam  \
            --output-prefix $WORKDIR/$sample

    # Sort and index VCF
    bcftools sort -Ob -o $WORKDIR/$sample.sorted.vcf.gz $WORKDIR/$sample.vcf.gz
    bcftools index $WORKDIR/$sample.sorted.vcf.gz

    # Sort and index BAM
    samtools sort -o $WORKDIR/$sample.spanning.sorted.bam $WORKDIR/$sample.spanning.bam
    samtools index $WORKDIR/$sample.spanning.sorted.bam

done

if [ $? -eq 0 ]; then
    echo "trgt" >> "$STEPS_DONE"
fi
