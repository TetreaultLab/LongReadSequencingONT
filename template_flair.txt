#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 8 # number of cores
#SBATCH --mem 32G # memory pool for all cores
#SBATCH -t 0-11:00 # time (D-HH:MM)
#SBATCH -o flair_{0}.%N.%j.log
#SBATCH -e flair_{0}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={1}

ml apptainer/1.4.5 bedtools/2.31.0

flair_img="/lustre09/project/6019267/shared/tools/splicing/flair/flair.sif"
intron_prospector_tool="/lustre09/project/6019267/shared/tools/splicing/flair/intronProspector/bin"
workdir="/lustre10/scratch/$USER/{2}/results/flair/{0}"
STEPS_DONE="{3}/scripts/steps_done.txt"

mkdir -p $workdir

# Find splice junctions with intronProspector
echo -e "\n=== Running IntronProspector ===\n"
apptainer run $flair_img $intron_prospector_tool/intronProspector \
    -c $workdir/{0}_intron_calls.tsv \
    -b $workdir/{0}_junctions.bed \
    -g {4} \
    -C 0.0 \
    {5}

echo -e "\n=== Running Flair transcriptome ===\n"
apptainer run $flair_img flair \
    transcriptome \
    -b {5} \
    -g {4} \
    -f {6} \
    -t 8 \
    --parallelmode bychrom \
    --junction_bed $workdir/{0}_junctions.bed \
    -o $workdir/{0}

echo -e "\n=== Running Bedtools bamtofastq ===\n"
bedtools bamtofastq -i {5} -fq $workdir/{0}.fastq

echo -e "\n=== Running Flair quantify ===\n"
apptainer run $flair_img flair \
    quantify \
    -r {7} \
    -i $workdir/{0}.isoforms.fa \
    --output $workdir/{0} \
    -t 8 \
    --temp_dir $workdir/tmp \
    --sample_id_only {0}

if [ $? -eq 0 ]; then
    echo "flair_{0}" >> "$STEPS_DONE"
fi
