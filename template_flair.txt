#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 8 # number of cores
#SBATCH --mem 32G # memory pool for all cores
#SBATCH -t 0-11:00 # time (D-HH:MM)
#SBATCH -o flair_{0}.%N.%j.log
#SBATCH -e flair_{0}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={1}

ml apptainer/1.4.5

flair_img="/lustre09/project/6019267/shared/tools/splicing/flair/flair.sif"
intron_prospector_tool="/lustre09/project/6019267/shared/tools/splicing/flair/intronProspector/bin"
workdir="/lustre10/scratch/$USER/{2}/results/flair/{0}"
STEPS_DONE="{3}/scripts/steps_done.txt"

mkdir -p $workdir

# Find splice junctions with intronProspector
apptainer run $flair_img $intron_prospector_tool/intronProspector \
    -c $workdir/{0}_intron_calls.tsv \
    -j $workdir/{0}_junctions.bed \
    -g {4} \
    -C 0.0 \
    {5}

apptainer run $flair_img flair \
    transcriptome \
    -b {5} \
    -g {3} \
    -f {6} \
    -t 8 \
    --parallelmode bychrom \
    --junction_bed $workdir/{0}_junctions.bed \
    -o $workdir/{0}

if [ $? -eq 0 ]; then
    echo "flair_{0}" >> "$STEPS_DONE"
fi