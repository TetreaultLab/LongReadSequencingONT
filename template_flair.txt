#!/bin/bash                                                                                 
#SBATCH -N 1 #Number of nodes                                                               
#SBATCH -n 8 # number of cores                                                              
#SBATCH --mem 32G # memory pool for all cores                                                
#SBATCH -t 0-11:00 # time (D-HH:MM)                                                         
#SBATCH -o flair_{0}.%N.%j.log                                                                   
#SBATCH -e flair_{0}.%N.%j.log                                                                                                                                              
#SBATCH --mail-type=FAIL                                                                    
#SBATCH --account=rrg-tetreaum                                                              
#SBATCH --mail-user={1}

ml apptainer

flair_img="/lustre09/project/6019267/shared/tools/splicing/flair/flair3.sif"
intron_prospector_tool="/lustre09/project/6019267/shared/tools/splicing/flair/intronProspector/bin"
workdir="/lustre10/scratch/$USER/{2}/results/flair/{0}"

mkdir -p $workdir

# Find splice junctions with intronProspector
$intron_prospector_tool/intronProspector \
    -c $workdir/{0}_intron_calls.tsv \ 
    -j $workdir/{0}_junctions.bed \
    -g {3} \
    -C 0.0 \
    {4}

$flair_img flair \
    transcriptome \
    -b {4} \
    -g {3} \
    -f {5} \
    -t 8 \
    --parallelmode bychrom \
    --junction_bed $workdir/{0}_junctions.bed \
    -o $workdir/{0}

if [ $? -eq 0 ]; then
    echo "flair_{0}" >> "$STEPS_DONE"
fi