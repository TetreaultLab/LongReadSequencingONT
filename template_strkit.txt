#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 1 # number of cores
#SBATCH --mem 3G # memory pool for all cores
#SBATCH -t 0-01:00 # time (D-HH:MM)
#SBATCH -o strkit_{0}.%N.%j.log
#SBATCH -e strkit_{0}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={1}

ml apptainer

IMAGE="apptainer run /lustre09/project/6019267/shared/tools/repeat_expansions/STRkit/strkit.sif"

# Project Directory
WORKDIR="/lustre10/scratch/$USER/{2}/results/STRkit/{0}"

# Steps done
STEPS_DONE="{3}/scripts/steps_done.txt"

# Reference Genome Path
GENOME={4}

# Repeat Definition File Path
REPEATS="/lustre09/project/6019267/shared/tools/repeat_expansions/reference_regions/strkit_pathogenic_converted.hg38.bed"

mkdir -p $WORKDIR

# Main STRkit Command
$IMAGE strkit call /lustre10/scratch/$USER/{2}/alignments/{0}_sorted.bam \
--hq \
--realign \
--ref $GENOME \
--loci $REPEATS \
--seed 342 \
--json $WORKDIR/{0}_last.json \
--vcf $WORKDIR/{0}_last.vcf \
--no-tsv \
--count-kmers both

# STRkit Visualizer
# $IMAGE strkit visualize /lustre10/scratch/$USER/{2}/alignments/{0}_sorted.bam \
# --ref hg38 \
# --json $WORKDIR/{0}_last.json \
# -i 1

if [ $? -eq 0 ]; then
    echo "strkit_{0}" >> "$STEPS_DONE"
fi