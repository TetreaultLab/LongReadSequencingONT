#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 1 # number of cores
#SBATCH --mem 4G # memory pool for all cores
#SBATCH -t 0-01:00 # time (D-HH:MM)
#SBATCH -o strkit.%N.%j.log
#SBATCH -e strkit.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={0}

ml apptainer

IMAGE="apptainer run /lustre09/project/6019267/shared/tools/repeat_expansions/STRkit/strkit.sif"
STEPS_DONE="{1}/scripts/steps_done.txt"
GENOME={2}
REPEATS="/lustre09/project/6019267/shared/tools/repeat_expansions/reference_regions/strkit_pathogenic_converted.hg38.bed"

for sample in {3}
do
    echo -e "\n===== Running $sample =====\n"
    WORKDIR="/lustre10/scratch/$USER/{4}/results/STRkit/$sample"
    mkdir -p $WORKDIR

    # Main STRkit Command
    $IMAGE strkit call /lustre10/scratch/$USER/{4}/alignments/$sample\_sorted.bam \
    --hq \
    --realign \
    --ref $GENOME \
    --loci $REPEATS \
    --seed 342 \
    --json $WORKDIR/$sample\_last.json \
    --vcf $WORKDIR/$sample\_last.vcf \
    --no-tsv \
    --count-kmers both

    # STRkit Visualizer
    # $IMAGE strkit visualize /lustre10/scratch/$USER/{4}/alignments/$sample\_sorted.bam \
    # --ref hg38 \
    # --json $WORKDIR/$sample\_last.json \
    # -i 1
done

if [ $? -eq 0 ]; then
    echo "strkit" >> "$STEPS_DONE"
fi