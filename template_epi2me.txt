#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH --cpus-per-task={0}
#SBATCH --mem {1}G # memory pool for all cores
#SBATCH -t {2} # time (DD-HH:MM)
#SBATCH -o {3}_{4}.%N.%j.log
#SBATCH -e {3}_{4}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={5}

set -euo pipefail

module load nextflow/25.04.6
module load apptainer

export NXF_DEFAULT_CPUS=1
export NXF_OVERRIDE_AVAILABLE_CPUS={0}
export NXF_DEFAULT_MEMORY=4GB
export NXF_DISABLE_UPDATE_CHECK=true
export NXF_OFFLINE=true
export NXF_SINGULARITY_CACHEDIR="/lustre09/project/6019267/shared/tools/main_pipelines/long-read/epi2me_cache/"
export _JAVA_OPTIONS="-XX:ActiveProcessorCount={0}"
export NXF_TEMP=/lustre10/scratch/$USER/{6}/results/epi2me/{4}/tmp

WORKDIR="/lustre10/scratch/$USER/{6}/results/epi2me/{4}/tmp"
BAM="/lustre10/scratch/$USER/{6}/alignments/{4}_sorted.bam"
OUT="/lustre10/scratch/$USER/{6}/results/epi2me/{4}"
APPTAINER_CONFIG="/lustre09/project/6019267/shared/tools/main_pipelines/long-read/LongReadSequencingONT/apptainer_nextflow.config"
STEPS_DONE="{7}/scripts/steps_done.txt"

mkdir -p $OUT
rm -r $WORKDIR

nextflow run epi2me-labs/wf-human-variation \
    {8} \
    --bam_min_coverage 4 \
    --override_basecaller_cfg {9} \
    -w $WORKDIR \
    --bam $BAM \
    --ref {10} \
    --modkit_args="--cpg --combine-strands --filter-threshold 0.70" \
    --sample_name {4} \
    --out_dir $OUT \
    --threads 1 \
    --ubam_map_threads 1 \
    --ubam_sort_threads 1 \
    --ubam_bam2fq_threads 1 \
    --modkit_threads 1 \
    -c $APPTAINER_CONFIG \
    -profile slurm_local

if [ $? -eq 0 ]; then
    echo "epi2me_{4}" >> "$STEPS_DONE"
fi
