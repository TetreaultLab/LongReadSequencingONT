#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH -n 8 # number of cores
#SBATCH --mem 32G # memory pool for all cores
#SBATCH -t 0-23:00 # time (D-HH:MM)
#SBATCH -o deepvariant_{0}.%N.%j.log
#SBATCH -e deepvariant_{0}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={1}

ml apptainer/1.4.5

DEEPVARIANT_IMAGE="apptainer run /lustre09/project/6019267/shared/tools/variants/SNPs/deepvariant/deepvariant.sif"
WORKDIR="/lustre10/scratch/$USER/{2}/results/deepvariant/{0}"

mkdir -p $WORKDIR
mkdir -p $WORKDIR/logs

$DEEPVARIANT_IMAGE /opt/deepvariant/bin/run_deepvariant \
        --reads {3} \
        --ref {4} \
        --model_type ONT_R104 \
        --output_vcf $WORKDIR/{0}_deepvariant.vcf \
        --logging_dir $WORKDIR/logs \
        --runtime_report \
        --vcf_stats_report \
        --make_examples_extra_args='small_model_call_multiallelics=false' \
        --postprocess_cpus 0 \
        --num_shards=$SLURM_CPUS_PER_TASK


if [ $? -eq 0 ]; then
    echo "deepvariant_{0}" >> "$STEPS_DONE"
fi